<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.furnycrew.furnidream.salesmanagement.model.dao.SalesMngMapper">
<!--    <resultMap id="salesDtoMap" type="com.furnycrew.furnidream.salesmanagement.model.dto.SalesMngDto">-->
<!--        <id column="order_code" property="orderCode"/>-->
<!--        <result column="created_at" property="createdAt"/>-->
<!--        <result column="total_price" property="totalPrice"/>-->

<!--                <association property="orderDto" javaType="com.furnycrew.furnidream.order.model.dto.OrderDto">-->
<!--                    <id column="order_code" property="orderCode"/>-->
<!--                    <result column="created_at" property="createdAt"/>-->
<!--                    <result column="total_price" property="totalPrice"/>-->
<!--                </association>-->
<!--        <collection property="orderProductList" ofType="orderProductDto" resultMap="orderProductResultMap"/>-->
<!--&lt;!&ndash;            <id column="order_code" property="orderCode"/>&ndash;&gt;-->
<!--&lt;!&ndash;            <id column="product_id" property="productId"/>&ndash;&gt;-->
<!--&lt;!&ndash;            <result column="quantity" property="quantity"/>&ndash;&gt;-->
<!--&lt;!&ndash;            <result column="price" property="price"/>&ndash;&gt;-->
<!--&lt;!&ndash;        </collection>&ndash;&gt;-->
<!--    </resultMap>-->

<!--        <resultMap id="orderProductResultMap" type="com.furnycrew.furnidream.order.model.dto.OrderProductDto">-->
<!--            <id column="order_code" property="orderCode"/>-->
<!--            <id column="product_id" property="productId"/>-->
<!--            <result column="quantity" property="quantity"/>-->
<!--            <result column="price" property="price"/>-->
<!--        </resultMap>-->


    <select id="findTotalSales" resultType="com.furnycrew.furnidream.salesmanagement.model.dto.SalesMngDto">
        select
            date_format(o.created_at, '%Y-%m-%d') createdAt,
            sum(op.quantity) orderAmount,
            sum(op.quantity * op.price) totalPrice,
            ifnull(sum(oc.refund_amount), 0) refundAmount,
            sum(op.quantity * op.price) - ifnull(sum(oc.refund_amount), 0) totalSales
        from
            tbl_order o left join tbl_order_product op
                on o.order_code = op.order_code
            left join tbl_order_canceled oc
                on op.order_code = oc.order_code
        group by
            date_format(o.created_at, '%Y-%m-%d')
        order by
            createdAt;
    </select>

    <select id="findMonthlySales" resultType="com.furnycrew.furnidream.salesmanagement.model.dto.SalesMngDto">
        select
            date_format(o.created_at, '%Y-%m') createdAt,
            sum(op.quantity) orderAmount,
            sum(op.quantity * op.price) totalPrice,
            ifnull(sum(oc.refund_amount), 0) refundAmount,
            sum(op.quantity * op.price) - ifnull(sum(oc.refund_amount), 0) totalSales
        from
            tbl_order
                left join tbl_order_product op
                    on o.order_code = op.order_code
                left join tbl_order_canceled oc
                    on op.order_code = oc.order_code
        group by
            date_format(o.created_at, '%Y-%m')
        order by
            createdAt;
    </select>



</mapper>
